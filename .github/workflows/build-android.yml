# .github/workflows/android-build.yml
name: Android Build & Release

on:
  push:
    branches: [main, develop, master]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - both

env:
  APP_NAME: 'Factory Manager Pro'
  PACKAGE_NAME: 'com.factorymanager.app'
  PYTHON_VERSION: '3.10.11'
  JAVA_VERSION: '17'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      is_release: ${{ steps.check_release.outputs.is_release }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from buildozer.spec
        id: extract_version
        run: |
          if [ -f "buildozer.spec" ]; then
            VERSION=$(grep -E '^version\s*=' buildozer.spec | cut -d'=' -f2 | xargs)
            echo "version=${VERSION:-2.0.1}" >> $GITHUB_OUTPUT
          else
            echo "version=2.0.1" >> $GITHUB_OUTPUT
          fi

      - name: Check if this is a release build
        id: check_release
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.build_type }}" =~ ^(release|both)$ ]] || [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  build-android:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      # ============================================
      # 1. CHECKOUT Y CONFIGURACI√ìN
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "BUILDOZER_WARN_ON_ROOT=0" >> $GITHUB_ENV
          echo "ANDROIDSDK=/home/runner/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
          echo "ANDROIDNDK=/home/runner/.buildozer/android/platform/android-ndk-r25b" >> $GITHUB_ENV
          echo "P4A_RELEASE_KEYSTORE=/home/runner/.buildozer/android/release.keystore" >> $GITHUB_ENV
          echo "P4A_RELEASE_KEYALIAS=android" >> $GITHUB_ENV
          echo "PATH=/home/runner/.local/bin:$PATH" >> $GITHUB_ENV

      # ============================================
      # 2. CONFIGURAR PYTHON Y JAVA
      # ============================================
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # ============================================
      # 3. INSTALAR DEPENDENCIAS DEL SISTEMA
      # ============================================
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-dev python3-venv \
            git zip unzip \
            openjdk-17-jdk \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev \
            libffi-dev libssl-dev libsqlite3-dev \
            libjpeg-dev libfreetype6-dev \
            libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            curl wget ninja-build cmake build-essential

      # ============================================
      # 4. CACHE PARA ACELERAR BUILDS
      # ============================================
      - name: Cache Buildozer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.gradle
            ~/.android
            /tmp/.buildozer_cache
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # ============================================
      # 5. INSTALAR DEPENDENCIAS DE PYTHON
      # ============================================
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools virtualenv
          pip install --user cython==0.29.36
          pip install --user buildozer==1.5.0
          
          # Dependencias del proyecto
          pip install --user kivy==2.3.0
          pip install --user "https://github.com/kivymd/KivyMD/archive/master.zip"
          pip install --user pillow fpdf2 plyer requests materialyoucolor
          
          # Instalar dependencias del requirements.txt si existe
          if [ -f "requirements.txt" ]; then
            pip install --user -r requirements.txt
          fi

      # ============================================
      # 6. CONFIGURAR KEYSTORE PARA RELEASE
      # ============================================
      - name: Setup release keystore
        if: needs.setup.outputs.is_release == 'true'
        run: |
          mkdir -p ~/.buildozer/android
          if [ ! -f ~/.buildozer/android/release.keystore ]; then
            echo "Generando keystore de release..."
            keytool -genkey -v -keystore ~/.buildozer/android/release.keystore \
              -alias android -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -dname "CN=Android Debug, O=Android, C=US"
          fi

      - name: Setup release keystore from secrets
        if: needs.setup.outputs.is_release == 'true' && secrets.KEYSTORE_BASE64
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > ~/.buildozer/android/release.keystore
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      # ============================================
      # 7. VERIFICAR CONFIGURACI√ìN
      # ============================================
      - name: Verify configuration
        run: |
          echo "=== CONFIGURACI√ìN DEL PROYECTO ==="
          echo "App: ${{ env.APP_NAME }}"
          echo "Package: ${{ env.PACKAGE_NAME }}"
          echo "Version: ${{ needs.setup.outputs.version }}"
          echo "Build Type: ${{ needs.setup.outputs.is_release == 'true' && 'Release' || 'Debug' }}"
          echo ""
          echo "=== VERIFICANDO ARCHIVOS ==="
          ls -la
          echo ""
          echo "=== VERIFICANDO buildozer.spec ==="
          if [ -f "buildozer.spec" ]; then
            grep -E "^(title|package\.name|package\.domain|version|requirements|android\.)" buildozer.spec
          fi

      # ============================================
      # 8. CONSTRUIR APK DEBUG
      # ============================================
      - name: Build Debug APK
        if: needs.setup.outputs.is_release == 'false' || github.event.inputs.build_type == 'both'
        run: |
          echo "=== CONSTRUYENDO APK DEBUG ==="
          
          # Limpiar builds anteriores
          rm -rf .buildozer/android/platform/build-* bin/ 2>/dev/null || true
          
          # Construir APK debug
          timeout 3600 buildozer -v android debug 2>&1 | tee build-debug.log
          
          BUILD_RESULT=${PIPESTATUS[0]}
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "‚úÖ APK Debug construido exitosamente!"
          else
            echo "‚ö† Buildozer termin√≥ con c√≥digo $BUILD_RESULT"
            # Verificar si al menos se gener√≥ el APK
            if find . -name "*.apk" -type f 2>/dev/null | grep -q .; then
              echo "‚úÖ APK generado a pesar del error"
            else
              echo "‚ùå No se gener√≥ APK"
              echo "=== √öltimas 50 l√≠neas del log ==="
              tail -50 build-debug.log
              exit 1
            fi
          fi

      # ============================================
      # 9. CONSTRUIR AAB RELEASE
      # ============================================
      - name: Build Release AAB
        if: needs.setup.outputs.is_release == 'true' || github.event.inputs.build_type == 'both'
        run: |
          echo "=== CONSTRUYENDO AAB RELEASE ==="
          
          # Limpiar builds anteriores
          rm -rf .buildozer/android/platform/build-* bin/ 2>/dev/null || true
          
          # Construir AAB release
          timeout 3600 buildozer -v android release 2>&1 | tee build-release.log
          
          BUILD_RESULT=${PIPESTATUS[0]}
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "‚úÖ AAB Release construido exitosamente!"
          else
            echo "‚ö† Buildozer termin√≥ con c√≥digo $BUILD_RESULT"
            # Verificar si al menos se gener√≥ el AAB
            if find . -name "*.aab" -type f 2>/dev/null | grep -q .; then
              echo "‚úÖ AAB generado a pesar del error"
            else
              echo "‚ùå No se gener√≥ AAB"
              echo "=== √öltimas 50 l√≠neas del log ==="
              tail -50 build-release.log
              exit 1
            fi
          fi

      # ============================================
      # 10. ORGANIZAR ARTEFACTOS
      # ============================================
      - name: Organize artifacts
        run: |
          echo "=== ORGANIZANDO ARTEFACTOS ==="
          mkdir -p bin/
          
          # Mover APKs a bin/
          find . -name "*.apk" -type f ! -path "./bin/*" 2>/dev/null | while read file; do
            echo "Moviendo APK: $file"
            mv "$file" bin/
          done
          
          # Mover AABs a bin/
          find . -name "*.aab" -type f ! -path "./bin/*" 2>/dev/null | while read file; do
            echo "Moviendo AAB: $file"
            mv "$file" bin/
          done
          
          echo ""
          echo "=== ARCHIVOS EN bin/ ==="
          ls -la bin/ || echo "bin/ vac√≠o"
          
          # Renombrar archivos con versi√≥n
          for file in bin/*.apk bin/*.aab 2>/dev/null; do
            if [ -f "$file" ]; then
              EXT="${file##*.}"
              BASENAME=$(basename "$file" ".$EXT")
              NEW_NAME="FactoryManagerPro-v${{ needs.setup.outputs.version }}-${BASENAME}.${EXT}"
              mv "$file" "bin/${NEW_NAME}"
              echo "Renombrado: $BASENAME.$EXT ‚Üí $NEW_NAME"
            fi
          done

      # ============================================
      # 11. SUBIR ARTEFACTOS DEBUG
      # ============================================
      - name: Upload Debug APK
        if: success() && (needs.setup.outputs.is_release == 'false' || github.event.inputs.build_type == 'both')
        uses: actions/upload-artifact@v4
        with:
          name: factory-manager-debug-apk
          path: bin/*.apk
          if-no-files-found: error
          retention-days: 30
          compression-level: 0

      # ============================================
      # 12. SUBIR ARTEFACTOS RELEASE
      # ============================================
      - name: Upload Release AAB
        if: success() && (needs.setup.outputs.is_release == 'true' || github.event.inputs.build_type == 'both')
        uses: actions/upload-artifact@v4
        with:
          name: factory-manager-release-aab
          path: bin/*.aab
          if-no-files-found: error
          retention-days: 90
          compression-level: 0

      # ============================================
      # 13. SUBIR LOGS
      # ============================================
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build-*.log
          retention-days: 7

  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          pip install flake8 pylint black

      - name: Run flake8
        run: |
          flake8 main.py modules/ --count --select=E9,F63,F7,F82 --show-source --statistics --max-line-length=120 || true

      - name: Check code formatting
        run: |
          black --check main.py modules/ --diff --color || true

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install test dependencies
        run: |
          pip install kivy==2.3.0
          pip install "https://github.com/kivymd/KivyMD/archive/master.zip"
          pip install pillow fpdf2 plyer requests materialyoucolor

      - name: Run basic tests
        run: |
          echo "=== EJECUTANDO PRUEBAS B√ÅSICAS ==="
          
          # Test 1: Importaci√≥n de m√≥dulos
          python -c "
import sys
sys.path.insert(0, '.')
try:
    from modules.database import DatabaseManager
    from modules.pdf_generator import PDFGenerator
    from modules.auth import AuthManager
    print('‚úÖ Todos los m√≥dulos importan correctamente')
except ImportError as e:
    print(f'‚ùå Error de importaci√≥n: {e}')
    sys.exit(1)
"
          
          # Test 2: Configuraci√≥n b√°sica
          python -c "
import sys
import os
sys.path.insert(0, '.')
from config import Config
config = Config()
print(f'‚úÖ Configuraci√≥n cargada')
print(f'  - App Name: {config.APP_NAME}')
print(f'  - Version: {config.VERSION}')
"
          
          # Test 3: Base de datos (sin conexi√≥n real)
          python -c "
import sys
sys.path.insert(0, '.')
from modules.database import DatabaseManager
db = DatabaseManager()
print(f'‚úÖ Manager de base de datos inicializado')
print(f'  - DB Path: {db.db_path if hasattr(db, \"db_path\") else \"Virtual\"}')
"
          
          # Test 4: Sintaxis de archivos principales
          python -c "
import ast
def check_syntax(filepath):
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            ast.parse(f.read())
        return True
    except SyntaxError as e:
        print(f'‚ùå Error de sintaxis en {filepath}: {e}')
        return False

files_to_check = ['main.py', 'config.py']
all_ok = True
for file in files_to_check:
    if check_syntax(file):
        print(f'‚úÖ {file}: Sintaxis correcta')
    else:
        all_ok = False

if all_ok:
    print('‚úÖ Todos los archivos tienen sintaxis correcta')
else:
    sys.exit(1)
"

  release:
    needs: [build-android, code-quality, test]
    if: success() && needs.setup.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: factory-manager-release-aab
          path: ./release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Factory Manager Pro v${{ needs.setup.outputs.version }}"
          body: |
            ## üè≠ Factory Manager Pro v${{ needs.setup.outputs.version }}
            
            ### üì¶ Qu√© hay de nuevo
            - Compilaci√≥n autom√°tica con GitHub Actions
            - KivyMD 2.0.1 con Material Design 3
            - Soporte Android 13+ (API 33)
            - Permisos modernos de almacenamiento
            - Generaci√≥n de PDFs con fpdf2
            - Base de datos SQLite3 persistente
            
            ### üì± Instalaci√≥n
            1. Descarga el archivo `.aab` para Google Play Store
            2. Descarga el archivo `.apk` para instalaci√≥n directa
            
            ### üîê Notas de Seguridad
            - Usuario por defecto: `admin`
            - Contrase√±a por defecto: `admin`
            - Cambia la contrase√±a en el primer inicio
            
            ### üêõ Reportar Problemas
            Abre un issue en el repositorio si encuentras alg√∫n problema.
            
            ### üìÑ Documentaci√≥n
            Consulta el README.md para m√°s informaci√≥n.
          files: ./release-artifacts/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build-android, code-quality, test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build status summary
        run: |
          echo "=== RESUMEN DEL BUILD ==="
          echo "Build Android: ${{ needs.build-android.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo ""
          
          if [ "${{ needs.build-android.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ ¬°TODOS LOS CHECKS PASARON!"
            echo "La APK/AAB ha sido generada exitosamente."
          else
            echo "‚ùå ALGUNOS CHECKS FALLARON"
            echo "Revisa los logs de GitHub Actions para m√°s detalles."
          fi
